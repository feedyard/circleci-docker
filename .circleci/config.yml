---
version: 2.1

orbs:
  circle-agent: feedyard/circleci-agent-publish@dev:latest

workflows:
  circleci-remote-docker-image-pipeline:
    jobs:
      - circle-agent/dev-release:
          context: ci
          registry: quay.io
          after_checkout:
            - run:
                name: Dockerfile lint
                command: hadolint Dockerfile
          after_build:
            - run:
                name: InSpec tests of docker image configuration
                command: |
                  set -euo pipefail
                  inspec exec --no-distinct-exit profiles/cis-docker
                  CID="$(docker run -it -d --entrypoint ash quay.io/feedyard/circleci-remote-docker:$CIRCLE_SHA1)"
                  inspec exec profiles/circleci-remote-docker/ -t docker://$CID
                  docker rm -f $CID
          filters:
            branches:
              only: master
            tags:
              ignore: /.*/
      - circle-agent/publish:
          context: ci
          registry: quay.io
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /.*/
